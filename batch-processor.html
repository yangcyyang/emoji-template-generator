<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¨æƒ…åŒ…æ‰¹é‡å¤„ç†å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <style>
        @font-face {
            font-family: 'LiuhuanKatong';
            src: url('./åˆ˜æ¬¢å¡é€šæ‰‹ä¹¦.ttf') format('truetype');
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'LiuhuanKatong', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a1a2e;
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; font-size: 28px; }
        
        /* çŠ¶æ€é¢æ¿ */
        .status-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .status-row:last-child { border-bottom: none; margin-bottom: 0; }
        .status-label { color: #aaa; }
        .status-value { color: #FECF78; font-weight: 600; }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FECF78, #FFB347);
            width: 0%;
            transition: width 0.3s ease;
        }
        .log-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.6;
        }
        .log-entry { margin-bottom: 4px; }
        .log-time { color: #666; margin-right: 8px; }
        .log-info { color: #4CAF50; }
        .log-error { color: #f44336; }
        .log-process { color: #2196F3; }
        
        /* éšè—çš„æ¨¡æ¿åŒºåŸŸ */
        .templates-wrapper {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
            opacity: 0;
            position: absolute;
            left: -9999px;
        }
        
        /* ============ å®Œå…¨å¤ç”¨åŸ index.html çš„æ¨¡æ¿æ ·å¼ ============ */
        .template1-card {
            width: 600px;
            height: 800px;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }
        .template1-header {
            height: 320px;
            display: flex;
            padding: 20px;
            gap: 20px;
            background: linear-gradient(135deg, #FECF78 0%, #FFB347 100%);
            flex-shrink: 0;
        }
        .template1-header-left {
            flex: 0 0 280px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .template1-main-image {
            width: 280px;
            height: 280px;
            object-fit: contain;
        }
        .template1-header-right {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .template1-header-top {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            padding: 5px 0;
        }
        .template1-count {
            color: rgba(255,255,255,0.95);
            font-size: 14px;
            font-weight: 500;
        }
        .template1-icons {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .template1-icons svg {
            width: 24px;
            height: 24px;
            display: block;
            flex-shrink: 0;
        }
        .template1-header-bottom {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            gap: 10px;
        }
        .template1-title {
            color: #fff;
            font-size: 42px;
            font-weight: 700;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.2);
            line-height: 1.2;
        }
        .template1-subtitle {
            color: rgba(255,255,255,0.95);
            font-size: 30px;
            font-weight: 500;
            text-shadow: 1px 1px 4px rgba(0,0,0,0.2);
        }
        .template1-grid {
            background: #fff;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 0;
            flex: 1;
        }
        .template1-item {
            background: transparent;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 200px;
            height: 160px;
        }
        .template1-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .template-grid-card {
            width: 600px;
            height: 800px;
            background: #fff;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .template-grid {
            display: grid;
            grid-template-columns: repeat(3, 200px);
            grid-template-rows: repeat(5, 160px);
            gap: 0;
            width: 600px;
            height: 800px;
        }
        .template-grid-item {
            width: 200px;
            height: 160px;
            background: transparent;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .template-grid-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .placeholder {
            color: #ccc;
            font-size: 14px;
            background: #f0f0f0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– è¡¨æƒ…åŒ…æ‰¹é‡å¤„ç†å™¨</h1>
        
        <div class="status-panel">
            <div class="status-row">
                <span class="status-label">å½“å‰å¤„ç†</span>
                <span class="status-value" id="current-folder">ç­‰å¾…å¼€å§‹...</span>
            </div>
            <div class="status-row">
                <span class="status-label">è¿›åº¦</span>
                <span class="status-value" id="progress-text">0 / 0</span>
            </div>
            <div class="status-row">
                <span class="status-label">çŠ¶æ€</span>
                <span class="status-value" id="status-text">å°±ç»ª</span>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-bar"></div>
            </div>
            
            <div class="log-panel" id="log-panel">
                <div class="log-entry"><span class="log-time">[ç³»ç»Ÿ]</span><span class="log-info">æ‰¹é‡å¤„ç†å™¨å·²å°±ç»ªï¼Œç­‰å¾…æŒ‡ä»¤...</span></div>
            </div>
        </div>
        
        <!-- éšè—çš„æ¨¡æ¿æ¸²æŸ“åŒº -->
        <div class="templates-wrapper" id="templates-wrapper">
            <!-- æ¨¡æ¿1 -->
            <div class="template-section">
                <div class="template-label">æ¨¡æ¿1 - å¤´å›¾</div>
                <div class="template1-card" id="template1-card">
                    <div class="template1-header" id="template1-header">
                        <div class="template1-header-left">
                            <img class="template1-main-image" id="template1-main-img" src="" alt="ä¸»å›¾" crossorigin="anonymous">
                        </div>
                        <div class="template1-header-right">
                            <div class="template1-header-top">
                                <span class="template1-count" id="template1-count">é™æ€è¡¨æƒ…åŒ… 40å¼ </span>
                                <div class="template1-icons">
                                    <!-- å¾®ä¿¡å›¾æ ‡ -->
                                    <svg viewBox="0 0 94 94" fill="none"><rect width="94" height="94" rx="20" fill="#07C160"/><path d="M38.5 35C36.5 35 35 36.5 35 38.5C35 40.5 36.5 42 38.5 42C40.5 42 42 40.5 42 38.5C42 36.5 40.5 35 38.5 35ZM55.5 47C54 47 52.5 48.2 52.5 49.5C52.5 50.8 54 52 55.5 52C57.5 52 58.5 50.5 58.5 49.5C58.5 48.5 57.5 47 55.5 47ZM50 42C52 42 53.5 40.5 53.5 38.5C53.5 36.5 52 35 50 35C48 35 46.5 36.5 46.5 38.5C46.5 40.5 48 42 50 42ZM65 47C64 47 62.5 48.2 62.5 49.5C62.5 50.8 63.5 52 65 52C67 52 68 50.5 68 49.5C68 48.5 67 47 65 47Z" fill="white"/><path d="M47 5C24 5 5 24 5 47C5 70 24 89 47 89C70 89 89 70 89 47C89 24 70 5 47 5ZM40 59C37.5 59 35.5 58.5 33 58L26.5 61.5L28.5 55.5C23.5 52 20.5 47.5 20.5 42C20.5 32.5 29 25 40 25C49.5 25 58 31 59.5 39C59 38.5 58.5 38.5 58 38.5C49 38.5 42 45.5 42 54C42 55.5 42.5 57 43 58.5C42 58.5 41 59 40 59ZM68.5 67.5L70 72.5L64.5 69.5C62.5 70 60.5 70.5 58.5 70.5C49 70.5 41.5 64 41.5 55.5C41.5 47.5 49 41 58 41C66.5 41 74 47.5 74 55.5C74 60 71 64 68.5 67.5Z" fill="white"/></svg>
                                    <!-- QQå›¾æ ‡ -->
                                    <svg viewBox="0 0 96 96" fill="none"><rect width="96" height="96" rx="20" fill="#12B7F5"/><path d="M48 85C41 85 35 83 31 80C29 80 26.5 81 25 82C23.5 83 23.5 84 24 84.5C25 86 43 85.5 48 85V85Z" fill="#FAAD08"/><path d="M47 85C54 85 60 83 64 80C66 80 68.5 81 70 82C71.5 83 71.5 84 71 84.5C70 86 52 85.5 47 85V85H47Z" fill="#FAAD08"/><path d="M47 44C58 44 67 42 70 41.5C70.5 41.5 71 41 71 41V39.5C71 25 64 10 47 10C30 10 23 25 23 39.5C23 40.5 23 42 23.5 42.5C23.5 42.5 23.5 42.5 24 42.5C27 43.5 36 44 47 44.5H47Z" fill="black"/><path d="M77.5 59C77 57 76 54.5 75 52C75 52 74.5 52 74 52C65.5 54.5 55 56 47.5 56H47C39.5 56 29 54.5 20.5 52C20 52 19.5 52 19.5 52C18.5 54.5 17.5 57 17 59C14 69.5 15 74 16 74C17.5 74 22.5 66 22.5 66C22.5 74.5 30 87.5 47.5 87.5H48.5C66 87.5 73.5 74.5 73.5 66C73.5 66 78.5 74 80 74C81 74 82 69.5 77.5 59Z" fill="black"/><path d="M41.5 30C39.5 30 38 28 37.5 25C37 22 39 20 41 20C43 20 44.5 22 45 25C45.5 28 43.5 30 41.5 30ZM58.5 25C58 28 56 30 54.5 30C52.5 30 50.5 28 51 25C51.5 22 53.5 20 55.5 20C57.5 20 59 22 58.5 25Z" fill="white"/><path d="M62 35.5C61.5 34 55.5 32.5 48 32.5H47.5C40 32.5 34 34 33.5 35.5C33.5 35.5 33.5 35.5 33.5 36C33.5 36.5 33.5 37 34 37.5C34.5 38.5 41 42.5 48 42.5H48.5C55.5 42.5 62 38.5 62.5 37.5C63 37 63 36.5 63 36C63 35.5 62.5 35.5 62 35.5Z" fill="#FAAD08"/></svg>
                                </div>
                            </div>
                            <div class="template1-header-bottom">
                                <div class="template1-title" id="template1-title">æ ‡é¢˜</div>
                                <div class="template1-subtitle" id="template1-subtitle">å‰¯æ ‡é¢˜</div>
                            </div>
                        </div>
                    </div>
                    <div class="template1-grid" id="template1-grid"></div>
                </div>
            </div>
            
            <!-- æ¨¡æ¿2 -->
            <div class="template-section">
                <div class="template-label">æ¨¡æ¿2 - ç½‘æ ¼1</div>
                <div class="template-grid-card" id="template2-card">
                    <div class="template-grid" id="template2-grid"></div>
                </div>
            </div>
            
            <!-- æ¨¡æ¿3 -->
            <div class="template-section">
                <div class="template-label">æ¨¡æ¿3 - ç½‘æ ¼2</div>
                <div class="template-grid-card" id="template3-card">
                    <div class="template-grid" id="template3-grid"></div>
                </div>
            </div>
            
            <!-- æ¨¡æ¿4 -->
            <div class="template-section">
                <div class="template-label">æ¨¡æ¿4 - ç½‘æ ¼3</div>
                <div class="template-grid-card" id="template4-card">
                    <div class="template-grid" id="template4-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // çŠ¶æ€ç®¡ç†
        let state = {
            folderInfo: null,
            isProcessing: false
        };
        
        // æ—¥å¿—
        function log(message, type = 'info') {
            const panel = document.getElementById('log-panel');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span><span class="log-${type}">${message}</span>`;
            panel.appendChild(entry);
            panel.scrollTop = panel.scrollHeight;
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(text) {
            document.getElementById('status-text').textContent = text;
        }
        
        // è·å–æ–‡ä»¶å¤¹ä¿¡æ¯
        async function fetchFolderInfo() {
            try {
                const response = await fetch('/api/folder');
                return await response.json();
            } catch (e) {
                log('è·å–æ–‡ä»¶å¤¹ä¿¡æ¯å¤±è´¥: ' + e.message, 'error');
                return null;
            }
        }
        
        // æ¸²æŸ“æ¨¡æ¿1
        async function renderTemplate1(info) {
            // è®¾ç½®æ ‡é¢˜
            document.getElementById('template1-title').textContent = info.title;
            document.getElementById('template1-subtitle').textContent = info.subtitle;
            document.getElementById('template1-count').textContent = `${info.anim_type} ${info.image_count}å¼ `;
            
            // è®¾ç½®ä¸»å›¾å¹¶æå–é¢œè‰²
            const mainImg = document.getElementById('template1-main-img');
            if (info.main_image) {
                mainImg.src = info.main_image.url;
                mainImg.style.display = 'block';
                
                // ä½¿ç”¨ ColorThief æå–ä¸»è‰²è°ƒ
                const colorThief = new ColorThief();
                const tempImg = new Image();
                tempImg.crossOrigin = 'anonymous';
                tempImg.src = info.main_image.url;
                tempImg.onload = () => {
                    try {
                        const color = colorThief.getColor(tempImg);
                        const rgba = `rgba(${color[0]}, ${color[1]}, ${color[2]}, 0.9)`;
                        document.getElementById('template1-header').style.background = rgba;
                    } catch(e) {}
                };
            }
            
            // å¡«å……9å®«æ ¼ï¼ˆç¬¬2-10å¼ å›¾ï¼‰
            const grid = document.getElementById('template1-grid');
            grid.innerHTML = '';
            const gridImages = info.images.slice(1, 10);
            
            for (let i = 0; i < 9; i++) {
                const div = document.createElement('div');
                div.className = 'template1-item';
                if (gridImages[i]) {
                    const img = document.createElement('img');
                    img.src = gridImages[i].url;
                    img.crossOrigin = 'anonymous';
                    div.appendChild(img);
                } else {
                    div.innerHTML = '<div class="placeholder">-</div>';
                }
                grid.appendChild(div);
            }
        }
        
        // æ¸²æŸ“ç½‘æ ¼æ¨¡æ¿
        function renderGridTemplate(templateId, info, startIdx) {
            const grid = document.getElementById(templateId);
            grid.innerHTML = '';
            
            const endIdx = startIdx + 15;
            let gridImages = info.images.slice(startIdx, endIdx);
            
            // ä¸è¶³15å¼ åˆ™å¾ªç¯
            while (gridImages.length < 15) {
                gridImages = gridImages.concat(info.images.slice(0, 15 - gridImages.length));
            }
            
            for (let i = 0; i < 15; i++) {
                const div = document.createElement('div');
                div.className = 'template-grid-item';
                if (gridImages[i]) {
                    const img = document.createElement('img');
                    img.src = gridImages[i].url;
                    img.crossOrigin = 'anonymous';
                    div.appendChild(img);
                } else {
                    div.innerHTML = '<div class="placeholder">-</div>';
                }
                grid.appendChild(div);
            }
        }
        
        // æ¸²æŸ“æ‰€æœ‰æ¨¡æ¿
        async function renderAllTemplates(info) {
            document.getElementById('current-folder').textContent = info.name;
            await renderTemplate1(info);
            renderGridTemplate('template2-grid', info, 0);      // ç¬¬1-15å¼ 
            renderGridTemplate('template3-grid', info, 15);     // ç¬¬16-30å¼ 
            renderGridTemplate('template4-grid', info, 30);     // ç¬¬31-45å¼ 
        }
        
        // æˆªå›¾å•ä¸ªæ¨¡æ¿
        async function captureTemplate(templateId, fileName) {
            const element = document.getElementById(templateId);
            const canvas = await html2canvas(element, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false
            });
            return {
                name: fileName,
                data: canvas.toDataURL('image/jpeg', 0.95)
            };
        }
        
        // å¤„ç†å½“å‰æ–‡ä»¶å¤¹
        async function processCurrentFolder() {
            state.isProcessing = true;
            updateStatus('è·å–æ–‡ä»¶å¤¹ä¿¡æ¯...');
            
            const info = await fetchFolderInfo();
            if (!info || info.error) {
                log('è·å–æ–‡ä»¶å¤¹ä¿¡æ¯å¤±è´¥', 'error');
                state.isProcessing = false;
                return null;
            }
            
            state.folderInfo = info;
            log(`å¼€å§‹å¤„ç†: ${info.name} (${info.image_count}å¼ å›¾ç‰‡)`);
            
            // æ¸²æŸ“æ¨¡æ¿
            updateStatus('æ¸²æŸ“æ¨¡æ¿...');
            await renderAllTemplates(info);
            
            // ç­‰å¾…é¢œè‰²æå–å®Œæˆ
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // æˆªå›¾æ‰€æœ‰æ¨¡æ¿
            updateStatus('ç”Ÿæˆå›¾ç‰‡...');
            const images = [];
            
            log('æˆªå›¾æ¨¡æ¿1...');
            images.push(await captureTemplate('template1-card', `01_å¤´å›¾_${info.name}.jpg`));
            
            log('æˆªå›¾æ¨¡æ¿2...');
            images.push(await captureTemplate('template2-card', `02_ç½‘æ ¼1_${info.name}.jpg`));
            
            log('æˆªå›¾æ¨¡æ¿3...');
            images.push(await captureTemplate('template3-card', `03_ç½‘æ ¼2_${info.name}.jpg`));
            
            log('æˆªå›¾æ¨¡æ¿4...');
            images.push(await captureTemplate('template4-card', `04_ç½‘æ ¼3_${info.name}.jpg`));
            
            // é€šè¿‡APIä¸Šä¼ å›¾ç‰‡æ•°æ®
            updateStatus('ä¸Šä¼ å›¾ç‰‡...');
            log('ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨...');
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        folder_name: info.name,
                        images: images
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    log(`âœ“ å·²ä¿å­˜ ${result.saved_files.length} å¼ å›¾ç‰‡`, 'info');
                    log(`âœ“ ZIP: ${result.zip}`, 'info');
                } else {
                    log('ä¸Šä¼ å¤±è´¥: ' + result.error, 'error');
                }
            } catch (e) {
                log('ä¸Šä¼ é”™è¯¯: ' + e.message, 'error');
            }
            
            // é€šçŸ¥æœåŠ¡å™¨å®Œæˆ
            await fetch('/api/complete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({folder_name: info.name})
            });
            
            state.isProcessing = false;
            updateStatus('å®Œæˆ');
            
            return info.name;
        }
        
        // å…¬å¼€APIä¾›å¤–éƒ¨è°ƒç”¨
        window.BatchProcessor = {
            process: processCurrentFolder,
            isProcessing: () => state.isProcessing
        };
        
        // å¯åŠ¨æ—¶è‡ªåŠ¨å¤„ç†ï¼ˆå¦‚æœé€šè¿‡URLå‚æ•°æŒ‡å®šï¼‰
        const params = new URLSearchParams(window.location.search);
        if (params.get('autostart') === '1') {
            setTimeout(processCurrentFolder, 1000);
        }
        
        log('æ‰¹é‡å¤„ç†å™¨å·²åŠ è½½ï¼Œç­‰å¾…æŒ‡ä»¤...', 'info');
    </script>
</body>
</html>
