<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¨æƒ…åŒ…æ¨¡æ¿ç”Ÿæˆå™¨ - å››æ¨¡æ¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @font-face {
            font-family: 'LiuhuanKatong';
            src: url('./åˆ˜æ¬¢å¡é€šæ‰‹ä¹¦.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'LiuhuanKatong', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a1a2e;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 2600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 16px;
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .control-row {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-group label {
            display: block;
            color: #aaa;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .control-group input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 16px;
            font-family: inherit;
        }

        .control-group input[type="text"]:focus {
            outline: none;
            border-color: #FECF78;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FECF78 0%, #FFB347 100%);
            color: #333;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(254, 207, 120, 0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: #fff;
        }

        /* å››æ¨¡æ¿é¢„è§ˆåŒº - 2x2ç½‘æ ¼ */
        .templates-wrapper {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            justify-items: center;
        }

        .template-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .template-section:hover {
            transform: scale(1.02);
        }

        .template-label {
            color: #FECF78;
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        /* ========== æ¨¡æ¿1æ ·å¼ - 1200Ã—1600 ========== */
        .template1-card {
            width: 600px;
            height: 800px;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .template1-header {
            height: 320px;
            display: flex;
            padding: 20px;
            gap: 20px;
            background: linear-gradient(135deg, #FECF78 0%, #FFB347 100%);
            flex-shrink: 0;
        }

        .template1-header-left {
            flex: 0 0 280px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .template1-main-image {
            width: 280px;
            height: 280px;
            object-fit: contain;
        }

        .template1-header-right {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .template1-header-top {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            padding: 5px 0;
        }

        .template1-count {
            color: rgba(255,255,255,0.95);
            font-size: 14px;
            font-weight: 500;
        }

        .template1-icons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .template1-icons svg,
        .template1-icons .social-icon {
            width: 24px;
            height: 24px;
            display: block;
            flex-shrink: 0;
            object-fit: contain;
        }

        .template1-header-bottom {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            gap: 10px;
        }

        .template1-title {
            color: #fff;
            font-size: 42px;
            font-weight: 700;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.2);
            line-height: 1.2;
        }

        .template1-subtitle {
            color: rgba(255,255,255,0.95);
            font-size: 30px;
            font-weight: 500;
            text-shadow: 1px 1px 4px rgba(0,0,0,0.2);
        }

        .template1-grid {
            background: #fff;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 0;
            flex: 1;
        }

        .template1-item {
            background: transparent;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 200px;
            height: 160px;
        }

        .template1-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* ========== æ¨¡æ¿2/3/4æ ·å¼ - 1200Ã—1600 çº¯ç½‘æ ¼ ========== */
        .template-grid-card {
            width: 600px;
            height: 800px;
            background: #fff;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(3, 200px);
            grid-template-rows: repeat(5, 160px);
            gap: 0;
            width: 600px;
            height: 800px;
        }

        .template-grid-item {
            width: 200px;
            height: 160px;
            background: transparent;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .template-grid-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* å ä½ç¬¦ */
        .placeholder {
            color: #ccc;
            font-size: 14px;
            background: #f0f0f0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* æ“ä½œæŒ‰é’® */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: center;
        }

        .action-buttons .btn {
            padding: 16px 40px;
            font-size: 18px;
        }

        /* è·¯å¾„æ˜¾ç¤º */
        .path-display {
            color: #FECF78;
            font-size: 14px;
            margin-top: 8px;
            word-break: break-all;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #FECF78;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading p {
            color: #fff;
            margin-top: 16px;
            font-size: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #folder-input, #main-image-input {
            display: none;
        }

        /* å¤§å›¾é¢„è§ˆæ¨¡æ€æ¡† */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-content img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        /* å“åº”å¼ */
        @media (max-width: 1300px) {
            .templates-wrapper {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ è¡¨æƒ…åŒ…æ¨¡æ¿ç”Ÿæˆå™¨</h1>
        <p class="subtitle">å››æ¨¡æ¿åŒæ—¶é¢„è§ˆï¼ˆç‚¹å‡»æ¨¡æ¿æŸ¥çœ‹å¤§å›¾ï¼‰- æ¨¡æ¿2/3/4æŒ‰æ­£åºå¾ªç¯åˆ†é…å›¾ç‰‡</p>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <div class="control-row">
                <div class="control-group" style="flex: 2;">
                    <label>ğŸ“ è¡¨æƒ…åŒ…å›¾ç‰‡æ–‡ä»¶å¤¹ï¼ˆæ¨¡æ¿2/3/4å„éœ€15å¼ ï¼Œå…±45å¼ ï¼Œä¸è¶³åˆ™å¾ªç¯ï¼‰</label>
                    <input type="text" id="folder-path" placeholder="é€‰æ‹©åŒ…å«è¡¨æƒ…åŒ…çš„æ–‡ä»¶å¤¹">
                    <div class="path-display" id="path-display"></div>
                </div>
                <div class="control-group" style="flex: 0 0 auto; display: flex; align-items: flex-end;">
                    <button class="btn btn-secondary" onclick="selectFolder()">ğŸ“‚ é€‰æ‹©æ–‡ä»¶å¤¹</button>
                    <input type="file" id="folder-input" webkitdirectory directory multiple onchange="handleFolderSelect(event)">
                </div>
            </div>

            <div class="control-row">
                <div class="control-group" style="flex: 2;">
                    <label>ğŸ–¼ï¸ æ¨¡æ¿1è‡ªå®šä¹‰ä¸»å›¾ï¼ˆå¯é€‰ï¼Œä¸é€‰åˆ™éšæœºæŠ½å–ï¼‰</label>
                    <input type="text" id="main-image-path" placeholder="ä¸é€‰åˆ™éšæœºï¼Œç‚¹å‡»å³ä¾§å¯æŒ‡å®šä¸»å›¾" readonly>
                    <div class="path-display" id="main-image-display">æœªé€‰æ‹©ï¼Œæ¨¡æ¿1å°†éšæœºæŠ½å–ä¸»å›¾</div>
                </div>
                <div class="control-group" style="flex: 0 0 auto; display: flex; align-items: flex-end;">
                    <button class="btn btn-secondary" onclick="selectMainImage()">ğŸ–¼ï¸ é€‰æ‹©ä¸»å›¾</button>
                    <input type="file" id="main-image-input" accept="image/*" onchange="handleMainImageSelect(event)">
                </div>
            </div>

            <div class="control-row">
                <div class="control-group">
                    <label>ä¸»æ ‡é¢˜</label>
                    <input type="text" id="main-title-input" value="èˆªæµ·ç‹" placeholder="è¾“å…¥ä¸»æ ‡é¢˜">
                </div>
                <div class="control-group">
                    <label>å‰¯æ ‡é¢˜</label>
                    <input type="text" id="sub-title-input" value="2026æ–°å¹´è¡¨æƒ…åŒ…" placeholder="è¾“å…¥å‰¯æ ‡é¢˜">
                </div>
                <div class="control-group">
                    <label>è¡¨æƒ…åŒ…æ•°é‡</label>
                    <input type="text" id="count-input" value="é™æ€è¡¨æƒ…åŒ… 40å¼ " placeholder="å¦‚ï¼š40å¼ ">
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="generatePreviews()">âœ¨ ç”Ÿæˆå››æ¨¡æ¿é¢„è§ˆ</button>
                <button class="btn btn-success" onclick="downloadAll()">ğŸ’¾ ä¸‹è½½å…¨éƒ¨å››ä¸ªæ¨¡æ¿</button>
            </div>
        </div>

        <!-- å››æ¨¡æ¿é¢„è§ˆåŒº -->
        <div class="templates-wrapper">
            <!-- æ¨¡æ¿1 -->
            <div class="template-section" onclick="showModal('template1-card')">
                <div class="template-label">æ¨¡æ¿1 - å¤´å›¾+æ ‡é¢˜+ä¹å®«æ ¼ï¼ˆéšæœº10å¼ ï¼‰</div>
                <div class="template1-card" id="template1-card">
                    <div class="template1-header" id="template1-header">
                        <div class="template1-header-left">
                            <img class="template1-main-image" id="template1-main-img" src="" alt="ä¸»å›¾" style="display: none;">
                            <div class="placeholder" id="template1-main-placeholder">ä¸»å›¾</div>
                        </div>
                        <div class="template1-header-right">
                            <div class="template1-header-top">
                                <span class="template1-count" id="template1-count">é™æ€è¡¨æƒ…åŒ… 40å¼ </span>
                                <div class="template1-icons">
                                    <img src="wechat-icon-new.png" alt="å¾®ä¿¡" class="social-icon">
                                    <img src="qq-icon-new.png" alt="QQ" class="social-icon">
                                </div>
                            </div>
                            <div class="template1-header-bottom">
                                <div class="template1-title" id="template1-title">èˆªæµ·ç‹</div>
                                <div class="template1-subtitle" id="template1-subtitle">2026æ–°å¹´è¡¨æƒ…åŒ…</div>
                            </div>
                        </div>
                    </div>
                    <div class="template1-grid" id="template1-grid">
                        <div class="template1-item"><span class="placeholder">1</span></div>
                        <div class="template1-item"><span class="placeholder">2</span></div>
                        <div class="template1-item"><span class="placeholder">3</span></div>
                        <div class="template1-item"><span class="placeholder">4</span></div>
                        <div class="template1-item"><span class="placeholder">5</span></div>
                        <div class="template1-item"><span class="placeholder">6</span></div>
                        <div class="template1-item"><span class="placeholder">7</span></div>
                        <div class="template1-item"><span class="placeholder">8</span></div>
                        <div class="template1-item"><span class="placeholder">9</span></div>
                    </div>
                </div>
            </div>

            <!-- æ¨¡æ¿2 -->
            <div class="template-section" onclick="showModal('template2-card')">
                <div class="template-label">æ¨¡æ¿2 - 3Ã—5ç½‘æ ¼ï¼ˆæ­£åº1-15å¼ ï¼‰</div>
                <div class="template-grid-card" id="template2-card">
                    <div class="template-grid" id="template2-grid">
                        <!-- 15ä¸ªå ä½ -->
                        <div class="template-grid-item"><span class="placeholder">1</span></div>
                        <div class="template-grid-item"><span class="placeholder">2</span></div>
                        <div class="template-grid-item"><span class="placeholder">3</span></div>
                        <div class="template-grid-item"><span class="placeholder">4</span></div>
                        <div class="template-grid-item"><span class="placeholder">5</span></div>
                        <div class="template-grid-item"><span class="placeholder">6</span></div>
                        <div class="template-grid-item"><span class="placeholder">7</span></div>
                        <div class="template-grid-item"><span class="placeholder">8</span></div>
                        <div class="template-grid-item"><span class="placeholder">9</span></div>
                        <div class="template-grid-item"><span class="placeholder">10</span></div>
                        <div class="template-grid-item"><span class="placeholder">11</span></div>
                        <div class="template-grid-item"><span class="placeholder">12</span></div>
                        <div class="template-grid-item"><span class="placeholder">13</span></div>
                        <div class="template-grid-item"><span class="placeholder">14</span></div>
                        <div class="template-grid-item"><span class="placeholder">15</span></div>
                    </div>
                </div>
            </div>

            <!-- æ¨¡æ¿3 -->
            <div class="template-section" onclick="showModal('template3-card')">
                <div class="template-label">æ¨¡æ¿3 - 3Ã—5ç½‘æ ¼ï¼ˆæ­£åº16-30å¼ ï¼‰</div>
                <div class="template-grid-card" id="template3-card">
                    <div class="template-grid" id="template3-grid">
                        <!-- 15ä¸ªå ä½ -->
                        <div class="template-grid-item"><span class="placeholder">16</span></div>
                        <div class="template-grid-item"><span class="placeholder">17</span></div>
                        <div class="template-grid-item"><span class="placeholder">18</span></div>
                        <div class="template-grid-item"><span class="placeholder">19</span></div>
                        <div class="template-grid-item"><span class="placeholder">20</span></div>
                        <div class="template-grid-item"><span class="placeholder">21</span></div>
                        <div class="template-grid-item"><span class="placeholder">22</span></div>
                        <div class="template-grid-item"><span class="placeholder">23</span></div>
                        <div class="template-grid-item"><span class="placeholder">24</span></div>
                        <div class="template-grid-item"><span class="placeholder">25</span></div>
                        <div class="template-grid-item"><span class="placeholder">26</span></div>
                        <div class="template-grid-item"><span class="placeholder">27</span></div>
                        <div class="template-grid-item"><span class="placeholder">28</span></div>
                        <div class="template-grid-item"><span class="placeholder">29</span></div>
                        <div class="template-grid-item"><span class="placeholder">30</span></div>
                    </div>
                </div>
            </div>

            <!-- æ¨¡æ¿4 -->
            <div class="template-section" onclick="showModal('template4-card')">
                <div class="template-label">æ¨¡æ¿4 - 3Ã—5ç½‘æ ¼ï¼ˆæ­£åº31-45å¼ ï¼‰</div>
                <div class="template-grid-card" id="template4-card">
                    <div class="template-grid" id="template4-grid">
                        <!-- 15ä¸ªå ä½ -->
                        <div class="template-grid-item"><span class="placeholder">31</span></div>
                        <div class="template-grid-item"><span class="placeholder">32</span></div>
                        <div class="template-grid-item"><span class="placeholder">33</span></div>
                        <div class="template-grid-item"><span class="placeholder">34</span></div>
                        <div class="template-grid-item"><span class="placeholder">35</span></div>
                        <div class="template-grid-item"><span class="placeholder">36</span></div>
                        <div class="template-grid-item"><span class="placeholder">37</span></div>
                        <div class="template-grid-item"><span class="placeholder">38</span></div>
                        <div class="template-grid-item"><span class="placeholder">39</span></div>
                        <div class="template-grid-item"><span class="placeholder">40</span></div>
                        <div class="template-grid-item"><span class="placeholder">41</span></div>
                        <div class="template-grid-item"><span class="placeholder">42</span></div>
                        <div class="template-grid-item"><span class="placeholder">43</span></div>
                        <div class="template-grid-item"><span class="placeholder">44</span></div>
                        <div class="template-grid-item"><span class="placeholder">45</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p id="loading-text">æ­£åœ¨ç”Ÿæˆ...</p>
    </div>

    <!-- å¤§å›¾é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="modal" id="modal" onclick="closeModal()">
        <button class="modal-close" onclick="closeModal()">Ã—</button>
        <div class="modal-content" id="modal-content" onclick="event.stopPropagation()">
            <!-- åŠ¨æ€æ’å…¥å¤§å›¾ -->
        </div>
    </div>

    <script>
        let allImages = [];
        let mainImageFile = null;

        function selectFolder() {
            document.getElementById('folder-input').click();
        }

        function handleFolderSelect(event) {
            const files = Array.from(event.target.files);
            const imageFiles = files.filter(f => 
                f.type.startsWith('image/') && 
                !f.name.startsWith('.') &&
                !f.name.includes('__MACOSX')
            );

            if (imageFiles.length < 1) {
                alert('æœªæ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            // æŒ‰æ–‡ä»¶åæ­£åºæ’åº
            allImages = imageFiles.sort((a, b) => a.name.localeCompare(b.name));
            
            const folderName = files[0]?.webkitRelativePath?.split('/')[0] || 'å·²é€‰æ‹©æ–‡ä»¶å¤¹';
            document.getElementById('path-display').textContent = 
                `${folderName} (${imageFiles.length} å¼ å›¾ç‰‡ï¼Œå·²æŒ‰æ–‡ä»¶åæ­£åºæ’åº)`;
            
            // æ™ºèƒ½æ‹†åˆ†æ ‡é¢˜
            const { mainTitle, subTitle } = parseFolderName(folderName);
            document.getElementById('main-title-input').value = mainTitle;
            document.getElementById('sub-title-input').value = subTitle;
            
            showToast(`ğŸ“ å·²è¯»å– ${imageFiles.length} å¼ å›¾ç‰‡`);
        }

        function parseFolderName(folderName) {
            let cleanName = folderName.replace(/\.zip$/i, '').replace(/^æœªå‘½åæ–‡ä»¶å¤¹$/i, '').trim();
            if (!cleanName) return { mainTitle: 'è¡¨æƒ…åŒ…', subTitle: '' };
            
            const separators = /[\s\-_Â·]+/;
            const parts = cleanName.split(separators).filter(p => p.trim());
            
            if (cleanName.includes('è¡¨æƒ…åŒ…')) {
                const emojiIndex = parts.findIndex(p => p.includes('è¡¨æƒ…åŒ…'));
                if (emojiIndex > 0) {
                    const mainParts = parts.slice(0, emojiIndex + 1);
                    const subParts = parts.slice(emojiIndex + 1);
                    return {
                        mainTitle: mainParts.join(''),
                        subTitle: subParts.join('') || 'ç²¾é€‰åˆé›†'
                    };
                } else if (emojiIndex === 0 && parts.length > 1) {
                    return { mainTitle: parts[0], subTitle: parts.slice(1).join('') };
                } else {
                    return { mainTitle: cleanName, subTitle: 'ç²¾é€‰åˆé›†' };
                }
            }
            
            const themeWords = ['æ˜¥å­£', 'å¤å­£', 'ç§‹å­£', 'å†¬å­£', 'æ˜¥å¤©', 'å¤å¤©', 'ç§‹å¤©', 'å†¬å¤©', 
                               'æ–°å¹´', 'æ˜¥èŠ‚', 'åœ£è¯', 'ä¸‡åœ£èŠ‚', 'æƒ…äººèŠ‚', 'å¤æ—¥', 'å†¬æ—¥',
                               'æ—¥å¸¸', 'å·¥ä½œ', 'å­¦ä¹ ', 'æ‹çˆ±', 'èŒç³»', 'æ…µæ‡’', 'å¯çˆ±'];
            
            for (let i = 0; i < parts.length; i++) {
                if (themeWords.some(theme => parts[i].includes(theme))) {
                    const mainParts = parts.slice(0, i + 1);
                    const subParts = parts.slice(i + 1);
                    let subTitle = subParts.join('');
                    if (!subTitle) {
                        subTitle = i > 0 ? mainParts.pop() : 'è¡¨æƒ…åŒ…';
                    }
                    return { mainTitle: mainParts.join('') + 'è¡¨æƒ…åŒ…', subTitle: subTitle };
                }
            }
            
            if (parts.length === 1) {
                return { mainTitle: cleanName + 'è¡¨æƒ…åŒ…', subTitle: 'ç²¾é€‰åˆé›†' };
            }
            
            const mid = Math.ceil(parts.length / 2);
            return { mainTitle: parts.slice(0, mid).join('') + 'è¡¨æƒ…åŒ…', subTitle: parts.slice(mid).join('') || 'ç²¾é€‰åˆé›†' };
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function selectMainImage() {
            document.getElementById('main-image-input').click();
        }

        function handleMainImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            mainImageFile = file;
            document.getElementById('main-image-path').value = file.name;
            document.getElementById('main-image-display').textContent = `å·²é€‰æ‹©: ${file.name}ï¼ˆå°†æ›¿æ¢æ¨¡æ¿1éšæœºä¸»å›¾ï¼‰`;
            showToast('ğŸ–¼ï¸ ä¸»å›¾å·²é€‰æ‹©');
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        // æŒ‰æ­£åºå¾ªç¯è·å–å›¾ç‰‡ï¼ˆæ¨¡æ¿2/3/4ä½¿ç”¨ï¼‰
        function getSequentialImages(templateIndex) {
            // templateIndex: 0=æ¨¡æ¿2, 1=æ¨¡æ¿3, 2=æ¨¡æ¿4
            const startIndex = templateIndex * 15; // 0, 15, 30
            const result = [];
            
            for (let i = 0; i < 15; i++) {
                const index = (startIndex + i) % allImages.length;
                result.push(allImages[index]);
            }
            
            return result;
        }

        async function generatePreviews() {
            if (allImages.length < 1) {
                alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶å¤¹');
                return;
            }

            const loading = document.getElementById('loading');
            loading.classList.add('active');

            try {
                // æ›´æ–°æ¨¡æ¿1æ–‡å­—
                document.getElementById('template1-title').textContent = document.getElementById('main-title-input').value;
                document.getElementById('template1-subtitle').textContent = document.getElementById('sub-title-input').value;
                document.getElementById('template1-count').textContent = document.getElementById('count-input').value;

                // ========== æ¨¡æ¿1ï¼šéšæœºæŠ½å–10å¼  ==========
                const shuffledForT1 = shuffleArray(allImages);
                const t1MainImgFile = mainImageFile || shuffledForT1[0];
                const t1MainData = await readFileAsDataURL(t1MainImgFile);
                
                const t1MainImg = document.getElementById('template1-main-img');
                t1MainImg.src = t1MainData;
                t1MainImg.style.display = 'block';
                document.getElementById('template1-main-placeholder').style.display = 'none';

                // æå–ä¸»è‰²è°ƒ
                const tempImg = new Image();
                tempImg.src = t1MainData;
                tempImg.onload = () => {
                    try {
                        const colorThief = new ColorThief();
                        const color = colorThief.getColor(tempImg);
                        const rgba = `rgba(${color[0]}, ${color[1]}, ${color[2]}, 0.9)`;
                        document.getElementById('template1-header').style.background = rgba;
                    } catch(e) {}
                };

                // å¡«å……æ¨¡æ¿1çš„9å¼ è¡¨æƒ…åŒ…
                const t1Grid = document.getElementById('template1-grid');
                t1Grid.innerHTML = '';
                const t1StickerImages = mainImageFile ? shuffledForT1.slice(0, 9) : shuffledForT1.slice(1, 10);
                
                for (let i = 0; i < 9; i++) {
                    const imgData = await readFileAsDataURL(t1StickerImages[i]);
                    const item = document.createElement('div');
                    item.className = 'template1-item';
                    const img = document.createElement('img');
                    img.src = imgData;
                    img.alt = `${i+1}`;
                    item.appendChild(img);
                    t1Grid.appendChild(item);
                }

                // ========== æ¨¡æ¿2ï¼šæ­£åº1-15å¼ ï¼ˆå¾ªç¯ï¼‰==========
                const t2Images = getSequentialImages(0);
                const t2Grid = document.getElementById('template2-grid');
                t2Grid.innerHTML = '';
                for (let i = 0; i < 15; i++) {
                    const imgData = await readFileAsDataURL(t2Images[i]);
                    const item = document.createElement('div');
                    item.className = 'template-grid-item';
                    const img = document.createElement('img');
                    img.src = imgData;
                    img.alt = `${i+1}`;
                    item.appendChild(img);
                    t2Grid.appendChild(item);
                }

                // ========== æ¨¡æ¿3ï¼šæ­£åº16-30å¼ ï¼ˆå¾ªç¯ï¼‰==========
                const t3Images = getSequentialImages(1);
                const t3Grid = document.getElementById('template3-grid');
                t3Grid.innerHTML = '';
                for (let i = 0; i < 15; i++) {
                    const imgData = await readFileAsDataURL(t3Images[i]);
                    const item = document.createElement('div');
                    item.className = 'template-grid-item';
                    const img = document.createElement('img');
                    img.src = imgData;
                    img.alt = `${i+16}`;
                    item.appendChild(img);
                    t3Grid.appendChild(item);
                }

                // ========== æ¨¡æ¿4ï¼šæ­£åº31-45å¼ ï¼ˆå¾ªç¯ï¼‰==========
                const t4Images = getSequentialImages(2);
                const t4Grid = document.getElementById('template4-grid');
                t4Grid.innerHTML = '';
                for (let i = 0; i < 15; i++) {
                    const imgData = await readFileAsDataURL(t4Images[i]);
                    const item = document.createElement('div');
                    item.className = 'template-grid-item';
                    const img = document.createElement('img');
                    img.src = imgData;
                    img.alt = `${i+31}`;
                    item.appendChild(img);
                    t4Grid.appendChild(item);
                }

                showToast('âœ¨ å››æ¨¡æ¿é¢„è§ˆç”ŸæˆæˆåŠŸï¼ç‚¹å‡»æ¨¡æ¿æŸ¥çœ‹å¤§å›¾');
            } catch (error) {
                console.error(error);
                alert('ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
            } finally {
                loading.classList.remove('active');
            }
        }

        async function downloadAll() {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loading-text');
            loading.classList.add('active');

            const templates = [
                { id: 'template1-card', name: 'æ¨¡æ¿1' },
                { id: 'template2-card', name: 'æ¨¡æ¿2' },
                { id: 'template3-card', name: 'æ¨¡æ¿3' },
                { id: 'template4-card', name: 'æ¨¡æ¿4' }
            ];

            const folderName = document.getElementById('main-title-input').value;
            const timestamp = Date.now();

            try {
                for (let i = 0; i < templates.length; i++) {
                    const template = templates[i];
                    loadingText.textContent = `æ­£åœ¨æ¸²æŸ“${template.name}...`;
                    
                    const canvas = await html2canvas(document.getElementById(template.id), {
                        scale: 2,
                        useCORS: true,
                        allowTaint: false,
                        backgroundColor: '#ffffff',
                        logging: false
                    });

                    const link = document.createElement('a');
                    link.download = `${template.name}_${folderName}_${timestamp}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.95);
                    link.click();

                    if (i < templates.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 800));
                    }
                }

                showToast('ğŸ’¾ å››ä¸ªæ¨¡æ¿å…¨éƒ¨ä¸‹è½½æˆåŠŸï¼');
            } catch (error) {
                console.error('ä¸‹è½½é”™è¯¯:', error);
                alert('ä¸‹è½½å¤±è´¥ï¼š' + error.message);
            } finally {
                loading.classList.remove('active');
                loadingText.textContent = 'æ­£åœ¨ç”Ÿæˆ...';
            }
        }

        // æ˜¾ç¤ºå¤§å›¾æ¨¡æ€æ¡†
        async function showModal(cardId) {
            const card = document.getElementById(cardId);
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            
            // æ¸²æŸ“é«˜æ¸…å¤§å›¾
            const canvas = await html2canvas(card, {
                scale: 2,
                useCORS: true,
                allowTaint: false,
                backgroundColor: '#ffffff',
                logging: false
            });

            modalContent.innerHTML = `<img src="${canvas.toDataURL('image/jpeg', 0.95)}" alt="é¢„è§ˆ">`;
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #333;
                color: #FECF78;
                padding: 16px 32px;
                border-radius: 10px;
                font-size: 16px;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // æ·»åŠ åŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
                to { opacity: 1; transform: translateX(-50%) translateY(0); }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: translateX(-50%) translateY(0); }
                to { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
